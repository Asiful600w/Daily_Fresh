'use client';

import React, { createContext, useContext, useEffect, useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { getUnreadNotifications, markNotificationAsViewed, markAllNotificationsAsViewed, OrderNotification } from '@/actions/notifications';

interface AdminNotificationContextType {
    notifications: OrderNotification[];
    unreadCount: number;
    markAsViewed: (orderId: string) => Promise<void>;
    markAllAsViewed: () => Promise<void>;
}

const AdminNotificationContext = createContext<AdminNotificationContextType | undefined>(undefined);

export function AdminNotificationProvider({ children }: { children: React.ReactNode }) {
    const [notifications, setNotifications] = useState<OrderNotification[]>([]);
    const [unreadCount, setUnreadCount] = useState(0);
    const router = useRouter();
    const audioRef = useRef<HTMLAudioElement | null>(null);

    // Initialize audio
    useEffect(() => {
        const ding = 'data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA//////////////////////////////////////////////////////////////////8AAABhTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUHAgAAAAAAAnEAAACAAABAAgAAgAAAAAAAHgAAAAAAAP//uQxBzAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAAAAABAAAAABAAAAAAAABAAAA';

        audioRef.current = new Audio(ding);
    }, []);

    const playNotificationSound = () => {
        if (audioRef.current) {
            audioRef.current.play().catch(e => console.error("Error playing sound/Interaction needed:", e));
        }
    };

    const fetchNotifications = async (checkForNew: boolean = false) => {
        try {
            const data = await getUnreadNotifications();

            if (checkForNew && data.length > notifications.length) {
                // New notification arrived
                playNotificationSound();
            }

            setNotifications(data);
            setUnreadCount(data.length);
        } catch (error) {
            console.error("Failed to fetch notifications:", error);
        }
    };

    useEffect(() => {
        // Define async function inside effect to avoid calling setState directly
        const initFetch = async () => {
            await fetchNotifications(false);
        };
        initFetch();

        // Poll every 30 seconds
        const interval = setInterval(() => {
            fetchNotifications(true);
        }, 30000);

        return () => clearInterval(interval);
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    const markAsViewed = async (orderId: string) => {
        try {
            await markNotificationAsViewed(orderId);
            setNotifications(prev => prev.filter(n => n.id !== orderId));
            setUnreadCount(prev => Math.max(0, prev - 1));
            router.push(`/admin/orders/${orderId}`);
        } catch (error) {
            console.error("Failed to mark as viewed", error);
        }
    };

    const markAllAsViewed = async () => {
        try {
            await markAllNotificationsAsViewed();
            setNotifications([]);
            setUnreadCount(0);
        } catch (error) {
            console.error("Failed to mark all as viewed", error);
        }
    };

    return (
        <AdminNotificationContext.Provider value={{ notifications, unreadCount, markAsViewed, markAllAsViewed }}>
            {children}
        </AdminNotificationContext.Provider>
    );
}

export function useAdminNotification() {
    const context = useContext(AdminNotificationContext);
    if (context === undefined) {
        throw new Error('useAdminNotification must be used within an AdminNotificationProvider');
    }
    return context;
}
